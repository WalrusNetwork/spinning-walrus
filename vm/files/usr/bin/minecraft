#!/bin/ash

exec 3>&1 4>&2
trap 'exec 2>&4 1>&3' 0 1 2 3
exec 1>/tmp/logs-minecraft.txt 2>&1

minecraft_directory=/data/minecraft/config

if [[ -n "$MOTD" ]]; then
    echo "changing MOTD"
    sed -i '/motd/d' ${minecraft_directory}/server.properties
    echo "motd=${MOTD}" >> ${minecraft_directory}/server.properties
elif [[ -n "$SERVERNAME" ]]; then
    sed -i '/motd/d' ${minecraft_directory}/server.properties
    echo "motd=\u00A73Walrus - Private Server - ${SERVERNAME}" >> ${minecraft_directory}/server.properties
fi

if [[ -n "$OP_USERNAME" && -n "$OP_UUID" ]]; then
    echo ""
    jq ". += [{uuid: \""$OP_UUID\"", name: \""$OP_USERNAME\"", level: 4, bypassesPlayerLimit: true}]" ${minecraft_directory}/ops.json|sponge ${minecraft_directory}/ops.json
fi

while true
do
    echo "Starting server.."
    cd ${minecraft_directory}
    java -XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:MaxGCPauseMillis=100 -XX:+DisableExplicitGC -XX:TargetSurvivorRatio=90\
    -XX:G1NewSizePercent=50 -XX:G1MaxNewSizePercent=80 -XX:G1MixedGCLiveThresholdPercent=35 -XX:+AlwaysPreTouch -XX:+ParallelRefProcEnabled -Dusing.aikars.flags=mcflags.emc.gs -jar sportpaper.jar
    echo "Restarting in 3 seconds, press CTRL+C to stop."
    sleep 3
done